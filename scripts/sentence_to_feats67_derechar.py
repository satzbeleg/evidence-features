from typing import List
import logging
from timeit import default_timer as timer
import argparse
import ray
import gc
import os
import psutil
import jsonlines



logger = logging.getLogger(__name__)
logging.basicConfig(
    level=logging.DEBUG,
    format="%(asctime)s - %(levelname)s - %(name)s: %(message)s",
    datefmt="%y-%m-%d %H:%M:%S"
)


# parse input arguments
parser = argparse.ArgumentParser()
parser.add_argument(
    '--input-file', default="./extracted.jsonl", type=str
)
parser.add_argument(
    '--output-file', default="./feats67.jsonl", type=str
)
parser.add_argument(
    '--batch-size', default=500000, type=int
)
args = parser.parse_args()


# CPU settings
PCT_CPU = float(os.environ.get("DERE_PCT_CPU", "0.9"))
NUM_CPU = os.environ.get("DERE_NUM_CPU")
if NUM_CPU is None:
    NUM_CPU = max(1, int(psutil.cpu_count(logical=False) * PCT_CPU))
ray.init(num_cpus=NUM_CPU)


# # Load the pretrained model
# MODELPATH = os.getenv("MODELFOLDER", "./models")
# MODELPATH = os.path.join(MODELPATH, "derechar.txt")

# # load DeReChar frequency list
# with open(MODELPATH, 'r') as fp:
#     dat = fp.readlines()

# dat = [s.lstrip() for s in dat]
# dat = [s for s in dat if len(s) >= 2]
# dat = [s for s in dat if 48 <= ord(s[0]) <= 57]
# dat = [s.split(" ") for s in dat]
# dat = [row for row in dat if len(row) == 2]
# dat = [(int(num.replace(".", "")), bi.split("\n")[0]) for num, bi in dat]

# derechar = {s: num for num, s in dat if len(s) == 1 and num > 0}
# denom = max([num for _, num in derechar.items()])
# derechar = {s: num / denom for s, num in derechar.items()}

# derebigr = {s: num for num, s in dat if len(s) == 2 and num > 0}
# denom = max([num for _, num in derebigr.items()])
# derebigr = {s: num / denom for s, num in derebigr.items()}

# del dat, denom
# gc.collect()


derechar = {
    'e': 1.0,
    'n': 0.6062893081761006,
    'i': 0.4817610062893082,
    'r': 0.4716981132075472,
    't': 0.3855345911949686,
    'a': 0.379874213836478,
    's': 0.35471698113207545,
    'u': 0.27358490566037735,
    'd': 0.2691823899371069,
    'h': 0.25345911949685535,
    'l': 0.22264150943396227,
    'o': 0.17672955974842766,
    'g': 0.17169811320754716,
    'c': 0.16352201257861634,
    'm': 0.1509433962264151,
    'b': 0.10628930817610063,
    'f': 0.09371069182389936,
    'k': 0.07232704402515723,
    'w': 0.07169811320754717,
    'z': 0.06918238993710692,
    'p': 0.04440251572327044,
    'v': 0.04283018867924528,
    'S': 0.04220125786163522,
    'D': 0.03119496855345912,
    'A': 0.028427672955974842,
    'B': 0.0269811320754717,
    'M': 0.024842767295597486,
    'K': 0.021446540880503146,
    'E': 0.020754716981132074,
    'F': 0.019559748427672954,
    'G': 0.019559748427672954,
    'W': 0.01861635220125786,
    'P': 0.01710691823899371,
    'H': 0.01509433962264151,
    'T': 0.014779874213836478,
    'R': 0.013710691823899371,
    'V': 0.013522012578616353,
    'L': 0.012767295597484277,
    'U': 0.010628930817610063,
    'ß': 0.010566037735849057,
    'I': 0.010377358490566037,
    'J': 0.010377358490566037,
    'N': 0.009811320754716982,
    'Z': 0.008679245283018867,
    'j': 0.007169811320754717,
    'O': 0.0057861635220125785,
    'y': 0.005773584905660377,
    'C': 0.004666666666666667,
    'x': 0.002767295597484277,
    'q': 0.0007924528301886792,
    'Q': 0.0006666666666666666,
    'Y': 0.0003018867924528302,
    'X': 5.0314465408805034e-05
}

derebigr = {
    'an': 0.2724795640326976,
    'au': 0.20463215258855585,
    'al': 0.15449591280653951,
    'ar': 0.14686648501362398,
    'as': 0.14141689373297003,
    'at': 0.13051771117166214,
    'ac': 0.08773841961852862,
    'ag': 0.08147138964577656,
    'am': 0.08065395095367847,
    'ah': 0.07629427792915532,
    'be': 0.2539509536784741,
    'ba': 0.035422343324250684,
    'bi': 0.03514986376021798,
    'br': 0.020790190735694825,
    'bu': 0.018038147138964577,
    'bl': 0.01754768392370572,
    'bs': 0.015967302452316076,
    'bt': 0.014032697547683924,
    'bo': 0.008583106267029973,
    'bg': 0.004959128065395096,
    'ch': 0.6457765667574932,
    'ck': 0.046866485013623976,
    'ce': 0.0047956403269754765,
    'co': 0.002888283378746594,
    'ca': 0.002316076294277929,
    'ci': 0.0014168937329700274,
    'cl': 0.0007356948228882834,
    'cu': 0.0007084468664850137,
    'ct': 0.0005994550408719346,
    'cc': 0.00043596730245231606,
    'de': 0.5367847411444142,
    'di': 0.1896457765667575,
    'da': 0.10354223433242507,
    'du': 0.027520435967302453,
    'dr': 0.018637602179836513,
    'do': 0.016866485013623977,
    'dt': 0.01634877384196185,
    'ds': 0.010817438692098093,
    'dl': 0.010054495912806539,
    'dn': 0.004141689373297002,
    'er': 1.0,
    'en': 0.9673024523160763,
    'ei': 0.49591280653950953,
    'es': 0.25231607629427794,
    'el': 0.17247956403269754,
    'et': 0.11307901907356949,
    'em': 0.1106267029972752,
    'eh': 0.08773841961852862,
    'eg': 0.07547683923705722,
    'eu': 0.06212534059945504,
    'fu': 0.06267029972752043,
    'fe': 0.06212534059945504,
    'ft': 0.04795640326975477,
    'fa': 0.038692098092643054,
    'ff': 0.02888283378746594,
    'fo': 0.02209809264305177,
    'fr': 0.020463215258855586,
    'fi': 0.016839237057220707,
    'fl': 0.011498637602179836,
    'fs': 0.0071662125340599455,
    'ge': 0.35149863760217986,
    'ga': 0.03923705722070845,
    'gt': 0.03896457765667575,
    'gs': 0.03569482288828338,
    'gi': 0.030245231607629427,
    'gr': 0.027247956403269755,
    'gl': 0.022697547683923704,
    'gu': 0.020190735694822888,
    'gn': 0.006566757493188011,
    'gk': 0.004141689373297002,
    'he': 0.22316076294277928,
    'ha': 0.13651226158038146,
    'hr': 0.12670299727520437,
    'ht': 0.1223433242506812,
    'hl': 0.054768392370572204,
    'hn': 0.041961852861035424,
    'ho': 0.04114441416893733,
    'hi': 0.04087193460490463,
    'hu': 0.02861035422343324,
    'hm': 0.02525885558583106,
    'in': 0.45776566757493187,
    'ie': 0.44686648501362397,
    'it': 0.21607629427792915,
    'ic': 0.20953678474114443,
    'is': 0.18147138964577655,
    'ig': 0.09455040871934604,
    'im': 0.0771117166212534,
    'il': 0.07193460490463215,
    'ir': 0.055858310626702996,
    'io': 0.041961852861035424,
    'je': 0.016485013623978202,
    'ja': 0.008474114441416894,
    'ju': 0.00446866485013624,
    'jo': 0.0007356948228882834,
    'ji': 0.00016348773841961853,
    'jk': 5.449591280653951e-05,
    'js': 5.449591280653951e-05,
    'jd': 2.7247956403269754e-05,
    'jn': 2.7247956403269754e-05,
    'jm': 2.7247956403269754e-05,
    'ke': 0.06621253405994551,
    'kt': 0.04495912806539509,
    'ko': 0.04305177111716621,
    'ka': 0.03814713896457766,
    'ku': 0.0211716621253406,
    'kl': 0.020517711171662126,
    'kr': 0.012670299727520436,
    'ks': 0.009564032697547685,
    'ki': 0.007656675749318801,
    'kn': 0.0025068119891008176,
    'le': 0.18038147138964578,
    'li': 0.144141689373297,
    'll': 0.12588555858310627,
    'la': 0.10435967302452316,
    'lt': 0.08038147138964577,
    'ls': 0.04741144414168937,
    'lu': 0.0326975476839237,
    'ld': 0.029427792915531336,
    'lo': 0.027520435967302453,
    'lb': 0.017384196185286103,
    'me': 0.11307901907356949,
    'mi': 0.08555858310626703,
    'ma': 0.06757493188010899,
    'mm': 0.05122615803814714,
    'mu': 0.025095367847411443,
    'mt': 0.016839237057220707,
    'mo': 0.015967302452316076,
    'mp': 0.015095367847411445,
    'ms': 0.012343324250681199,
    'mb': 0.010408719346049046,
    'nd': 0.329700272479564,
    'ne': 0.2539509536784741,
    'ng': 0.20272479564032697,
    'nt': 0.13841961852861034,
    'ns': 0.10108991825613078,
    'nn': 0.09564032697547684,
    'ni': 0.09209809264305177,
    'na': 0.08010899182561308,
    'nz': 0.03923705722070845,
    'nk': 0.037874659400544956,
    'on': 0.17002724795640328,
    'or': 0.13596730245231609,
    'ol': 0.07520435967302452,
    'oc': 0.04550408719346049,
    'om': 0.04332425068119891,
    'os': 0.037057220708446865,
    'ot': 0.02997275204359673,
    'oh': 0.02659400544959128,
    'of': 0.022724795640326974,
    'od': 0.020463215258855586,
    'pr': 0.030517711171662125,
    'pe': 0.027193460490463214,
    'pa': 0.024904632152588556,
    'pi': 0.024795640326975475,
    'po': 0.015095367847411445,
    'pp': 0.014059945504087193,
    'pf': 0.013460490463215258,
    'pl': 0.011580381471389645,
    'pt': 0.009700272479564032,
    'pu': 0.007220708446866485,
    'qu': 0.00332425068119891,
    're': 0.244141689373297,
    'ra': 0.144141689373297,
    'rt': 0.13160762942779292,
    'ri': 0.11144414168937329,
    'rs': 0.08719346049046321,
    'rd': 0.08610354223433242,
    'ru': 0.08228882833787465,
    'ro': 0.07302452316076294,
    'rn': 0.06267029972752043,
    'rg': 0.05367847411444142,
    'st': 0.28337874659400547,
    'se': 0.18555858310626702,
    'sc': 0.17438692098092642,
    'si': 0.12098092643051771,
    'ss': 0.11389645776566758,
    'so': 0.05722070844686648,
    'sa': 0.05204359673024523,
    'sp': 0.04141689373297003,
    'su': 0.017138964577656676,
    'sg': 0.014931880108991826,
    'ße': 0.02242506811989101,
    'ßt': 0.0045504087193460495,
    'ßl': 0.0020435967302452314,
    'ßb': 0.0019346049046321525,
    'ßi': 0.001335149863760218,
    'ßn': 0.0010626702997275205,
    'ßg': 0.0004904632152588556,
    'ßu': 0.00038147138964577656,
    'ßs': 0.00038147138964577656,
    'ßw': 0.0002997275204359673,
    'te': 0.46866485013623976,
    'ti': 0.10926430517711172,
    'ta': 0.10899182561307902,
    'ts': 0.06948228882833787,
    'tr': 0.06948228882833787,
    'tt': 0.06621253405994551,
    'tz': 0.06403269754768393,
    'tu': 0.05231607629427793,
    'to': 0.033787465940054495,
    'tl': 0.026103542234332425,
    'un': 0.329700272479564,
    'ur': 0.1673024523160763,
    'us': 0.12697547683923704,
    'uf': 0.0782016348773842,
    'uc': 0.07111716621253406,
    'ut': 0.06948228882833787,
    'um': 0.06566757493188011,
    'ub': 0.04005449591280654,
    'ue': 0.03514986376021798,
    'ul': 0.030245231607629427,
    'vo': 0.08392370572207085,
    've': 0.07084468664850137,
    'vi': 0.020490463215258856,
    'va': 0.005831062670299728,
    'vs': 0.00027247956403269756,
    'vu': 0.00013623978201634878,
    'vr': 0.00013623978201634878,
    'vt': 0.00010899182561307902,
    'vg': 8.174386920980927e-05,
    'vk': 8.174386920980927e-05,
    'we': 0.10735694822888284,
    'wi': 0.08174386920980926,
    'wa': 0.06321525885558583,
    'wo': 0.026403269754768394,
    'wu': 0.021907356948228884,
    'ww': 0.002343324250681199,
    'ws': 0.000899182561307902,
    'wn': 0.0002997275204359673,
    'wj': 0.00016348773841961853,
    'wl': 0.00010899182561307902,
    'xi': 0.0020435967302452314,
    'xp': 0.0018528610354223434,
    'xt': 0.001771117166212534,
    'xe': 0.0012534059945504088,
    'xa': 0.0008446866485013624,
    'xu': 0.00043596730245231606,
    'xo': 0.00019073569482288828,
    'xk': 0.00016348773841961853,
    'xx': 0.00013623978201634878,
    'xz': 0.00010899182561307902,
    'ys': 0.0031607629427792914,
    'ye': 0.002997275204359673,
    'ym': 0.002343324250681199,
    'yl': 0.0010626702997275205,
    'yp': 0.0010626702997275205,
    'yr': 0.0010081743869209809,
    'yn': 0.0009809264305177111,
    'yc': 0.0007901907356948228,
    'ya': 0.0005994550408719346,
    'yt': 0.0005177111716621253,
    'zu': 0.1002724795640327,
    'ze': 0.07111716621253406,
    'zi': 0.025231607629427794,
    'zt': 0.021008174386920982,
    'zw': 0.01891008174386921,
    'za': 0.008501362397820164,
    'zl': 0.00444141689373297,
    'zo': 0.00438692098092643,
    'zb': 0.0020980926430517713,
    'zs': 0.0013623978201634877,
    'ab': 0.06757493188010899,
    'eb': 0.05694822888283379,
    'rb': 0.04005449591280654,
    'ob': 0.018365122615803815,
    'ib': 0.017247956403269756,
    'nb': 0.01664850136239782,
    'Ab': 0.01340599455040872,
    'sb': 0.012588555858310627,
    'Sc': 0.03978201634877384,
    'ec': 0.032970027247956404,
    'rc': 0.021771117166212533,
    'nc': 0.008174386920980926,
    'Ic': 0.004523160762942779,
    'ed': 0.05040871934604905,
    'ad': 0.03651226158038147,
    'id': 0.024604904632152588,
    'ud': 0.01337874659400545,
    'sd': 0.004986376021798365,
    'td': 0.002125340599455041,
    'af': 0.03814713896457766,
    'ef': 0.032152588555858314,
    'rf': 0.029427792915531336,
    'nf': 0.026049046321525885,
    'if': 0.013950953678474114,
    'lf': 0.013896457765667575,
    'ug': 0.02645776566757493,
    'og': 0.020217983651226158,
    'lg': 0.011580381471389645,
    'tg': 0.010217983651226158,
    'ih': 0.02681198910081744,
    'uh': 0.024877384196185286,
    'rh': 0.02201634877384196,
    'th': 0.017711171662125342,
    'nh': 0.014032697547683924,
    'Uh': 0.012152588555858311,
    'Di': 0.04577656675749319,
    'oj': 0.0025340599455040873,
    'nj': 0.0014168937329700274,
    'rj': 0.0013079019073569482,
    'sj': 0.0010081743869209809,
    'bj': 0.0005722070844686648,
    'lj': 0.0005722070844686648,
    'tj': 0.0005449591280653951,
    'ej': 0.0005449591280653951,
    'aj': 0.0005177111716621253,
    'ij': 0.00043596730245231606,
    'rk': 0.042779291553133515,
    'ek': 0.024850136239782016,
    'ik': 0.02449591280653951,
    'ak': 0.013460490463215258,
    'sk': 0.01204359673024523,
    'lk': 0.008174386920980926,
    'uk': 0.0060490463215258855,
    'ok': 0.005313351498637603,
    'rl': 0.0326975476839237,
    'rm': 0.029427792915531336,
    'sm': 0.008501362397820164,
    'nm': 0.008010899182561308,
    'An': 0.025040871934604903,
    'In': 0.02444141689373297,
    'no': 0.02888283378746594,
    'Sp': 0.019509536784741145,
    'op': 0.014059945504087193,
    'ep': 0.012152588555858311,
    'up': 0.011498637602179836,
    'ap': 0.009318801089918257,
    'rp': 0.006948228882833788,
    'ip': 0.005231607629427793,
    'eq': 0.0007356948228882834,
    'iq': 0.0002997275204359673,
    'rq': 0.0002997275204359673,
    'sq': 0.00027247956403269756,
    'nq': 0.00019073569482288828,
    'aq': 0.00010899182561307902,
    'Aq': 0.00010899182561307902,
    'cq': 8.174386920980927e-05,
    'tq': 5.449591280653951e-05,
    'hq': 5.449591280653951e-05,
    'Fr': 0.024877384196185286,
    'aß': 0.012425068119891008,
    'oß': 0.011989100817438692,
    'uß': 0.00888283378746594,
    'eß': 0.007111716621253406,
    'iß': 0.005258855585831062,
    'Au': 0.03569482288828338,
    'nu': 0.03433242506811989,
    'iv': 0.014713896457765668,
    'sv': 0.005885558583106267,
    'ev': 0.005803814713896458,
    'rv': 0.005694822888283379,
    'nv': 0.0054223433242506815,
    'av': 0.0051771117166212535,
    'ov': 0.004822888283378747,
    'lv': 0.0033787465940054496,
    'tv': 0.003242506811989101,
    'uv': 0.0020435967302452314,
    'ew': 0.02550408719346049,
    'tw': 0.0176566757493188,
    'rw': 0.017493188010899184,
    'hw': 0.016539509536784743,
    'ow': 0.00880108991825613,
    'sw': 0.008446866485013624,
    'nw': 0.007629427792915531,
    'Zw': 0.004332425068119891,
    'dw': 0.003542234332425068,
    'ex': 0.005013623978201635,
    'Ex': 0.002125340599455041,
    'ax': 0.0018528610354223434,
    'ix': 0.0009536784741144414,
    'ox': 0.0006267029972752044,
    'ux': 0.0005722070844686648,
    'Ax': 0.00019073569482288828,
    'rx': 0.00013623978201634878,
    'nx': 2.7247956403269754e-05,
    'ay': 0.00335149863760218,
    'ey': 0.0025885558583106268,
    'ly': 0.0021798365122615805,
    'sy': 0.002125340599455041,
    'ty': 0.0014713896457765668,
    'ry': 0.0014168937329700274,
    'Sy': 0.0013623978201634877,
    'by': 0.00111716621253406,
    'dy': 0.0010354223433242506,
    'ny': 0.0010081743869209809,
    'rz': 0.024277929155313353,
    'iz': 0.012697547683923706,
    'ez': 0.011280653950953679,
    'oz': 0.008991825613079018,
    'lz': 0.006566757493188011,
    'az': 0.005476839237057221,
    'sz': 0.005395095367847411,
    'uz': 0.0031335149863760217,
    'Al': 0.014114441416893733,
    'Ar': 0.011662125340599456,
    'Am': 0.006893732970027248,
    'Ak': 0.003242506811989101,
    'Ap': 0.002070844686648501,
    'At': 0.001798365122615804,
    'As': 0.0017166212534059945,
    'Be': 0.04713896457765668,
    'Ba': 0.02002724795640327,
    'Bu': 0.01760217983651226,
    'Br': 0.00997275204359673,
    'Bi': 0.009482288828337874,
    'Bo': 0.007247956403269755,
    'Bl': 0.004904632152588556,
    'Bj': 8.174386920980927e-05,
    'By': 2.7247956403269754e-05,
    'Ch': 0.00896457765667575,
    'Co': 0.0039237057220708445,
    'Ca': 0.0030517711171662125,
    'Cl': 0.0015803814713896457,
    'Ce': 0.0007629427792915531,
    'Cr': 0.0006539509536784741,
    'Ci': 0.0004904632152588556,
    'Cu': 0.00035422343324250684,
    'Cy': 5.449591280653951e-05,
    'Cz': 5.449591280653951e-05,
    'De': 0.036239782016348775,
    'Da': 0.03188010899182561,
    'Do': 0.010953678474114442,
    'Dr': 0.0051771117166212535,
    'Du': 0.00446866485013624,
    'Dy': 0.00016348773841961853,
    'Ds': 8.174386920980927e-05,
    'Dj': 5.449591280653951e-05,
    'Dh': 2.7247956403269754e-05,
    'Ei': 0.024795640326975475,
    'Er': 0.020653950953678474,
    'En': 0.011471389645776566,
    'Eu': 0.009400544959128065,
    'Es': 0.007847411444141689,
    'El': 0.004359673024523161,
    'Eh': 0.001989100817438692,
    'Em': 0.0012806539509536785,
    'Eb': 0.0010354223433242506,
    'Fa': 0.014741144414168938,
    'Fe': 0.01103542234332425,
    'Fu': 0.010190735694822888,
    'Fo': 0.009509536784741144,
    'Fi': 0.008310626702997275,
    'Fl': 0.005967302452316076,
    'Ge': 0.04250681198910082,
    'Gr': 0.016920980926430518,
    'Ga': 0.009182561307901908,
    'Go': 0.00446866485013624,
    'Gl': 0.003896457765667575,
    'Gu': 0.003787465940054496,
    'Gi': 0.001880108991825613,
    'Gy': 0.0004904632152588556,
    'Gn': 0.00010899182561307902,
    'Gh': 8.174386920980927e-05,
    'Ha': 0.023651226158038146,
    'He': 0.01776566757493188,
    'Ho': 0.012397820163487738,
    'Hi': 0.007329700272479564,
    'Hu': 0.0037057220708446867,
    'Hy': 0.0002997275204359673,
    'Hr': 2.7247956403269754e-05,
    'Im': 0.0071662125340599455,
    'Ih': 0.0023978201634877383,
    'Is': 0.0015803814713896457,
    'Id': 0.0013079019073569482,
    'Ir': 0.0011989100817438691,
    'It': 0.0007084468664850137,
    'Il': 0.0005177111716621253,
    'Ig': 0.00013623978201634878,
    'Ja': 0.024604904632152588,
    'Ju': 0.011280653950953679,
    'Jo': 0.0047956403269754765,
    'Je': 0.003869209809264305,
    'Ji': 0.00016348773841961853,
    'Ko': 0.02223433242506812,
    'Ka': 0.017302452316076293,
    'Ki': 0.013188010899182562,
    'Kr': 0.012970027247956404,
    'Ku': 0.011907356948228883,
    'Kl': 0.008637602179836511,
    'Ke': 0.004686648501362398,
    'Kn': 0.0014713896457765668,
    'Ky': 0.00010899182561307902,
    'Kh': 0.00010899182561307902,
    'La': 0.018637602179836513,
    'Le': 0.016975476839237058,
    'Li': 0.00893732970027248,
    'Lo': 0.0055858310626703,
    'Lu': 0.004604904632152589,
    'Ly': 0.00019073569482288828,
    'Lk': 0.00010899182561307902,
    'Ll': 2.7247956403269754e-05,
    'Ma': 0.03487738419618529,
    'Mi': 0.029427792915531336,
    'Me': 0.018038147138964577,
    'Mo': 0.014141689373297003,
    'Mu': 0.010490463215258856,
    'My': 0.00019073569482288828,
    'Mr': 2.7247956403269754e-05,
    'Na': 0.016948228882833788,
    'Ne': 0.009564032697547685,
    'No': 0.006485013623978202,
    'Ni': 0.005749318801089918,
    'Nu': 0.0036239782016348776,
    'Ny': 2.7247956403269754e-05,
    'Or': 0.005667574931880109,
    'Ob': 0.004523160762942779,
    'Os': 0.0032152588555858313,
    'Op': 0.002425068119891008,
    'Of': 0.001880108991825613,
    'Ol': 0.0018256130790190736,
    'Ok': 0.001771117166212534,
    'Oh': 0.0008174386920980927,
    'Od': 0.0005994550408719346,
    'Ot': 0.0005722070844686648,
    'Pr': 0.02346049046321526,
    'Pa': 0.014005449591280654,
    'Po': 0.010326975476839237,
    'Pe': 0.0067847411444141685,
    'Pl': 0.006348773841961853,
    'Pf': 0.004332425068119891,
    'Pu': 0.004250681198910082,
    'Pi': 0.002343324250681199,
    'Ph': 0.001553133514986376,
    'Ps': 0.00032697547683923706,
    'Qu': 0.0028337874659400547,
    'Re': 0.024005449591280655,
    'Ra': 0.0111716621253406,
    'Ro': 0.00891008174386921,
    'Ru': 0.008310626702997275,
    'Ri': 0.005449591280653951,
    'Rh': 0.0011716621253405994,
    'Ry': 8.174386920980927e-05,
    'St': 0.04550408719346049,
    'Si': 0.01880108991825613,
    'Se': 0.01678474114441417,
    'So': 0.016539509536784743,
    'Sa': 0.01561307901907357,
    'Su': 0.0044141689373297,
    'Sk': 0.0013079019073569482,
    'Ta': 0.012833787465940055,
    'Te': 0.012806539509536785,
    'Tr': 0.011771117166212534,
    'To': 0.008637602179836511,
    'Th': 0.007656675749318801,
    'Ti': 0.005749318801089918,
    'Tu': 0.0034059945504087193,
    'Ts': 0.0004904632152588556,
    'Ty': 0.0002452316076294278,
    'Tw': 0.00010899182561307902,
    'Un': 0.018201634877384198,
    'Um': 0.005831062670299728,
    'Ub': 0.004523160762942779,
    'Ur': 0.002425068119891008,
    'Ul': 0.0010081743869209809,
    'Uw': 0.0002997275204359673,
    'Ut': 0.00021798365122615803,
    'Us': 0.00021798365122615803,
    'Ue': 0.00019073569482288828,
    'Ve': 0.029155313351498638,
    'Vo': 0.020926430517711172,
    'Vi': 0.006076294277929156,
    'Va': 0.002070844686648501,
    'Vu': 0.00010899182561307902,
    'Vl': 5.449591280653951e-05,
    'Vr': 2.7247956403269754e-05,
    'We': 0.02806539509536785,
    'Wi': 0.020790190735694825,
    'Wa': 0.017111716621253405,
    'Wo': 0.011525885558583106,
    'Wu': 0.0026975476839237057,
    'Wh': 0.00013623978201634878,
    'Wr': 8.174386920980927e-05,
    'Wl': 8.174386920980927e-05,
    'Wy': 5.449591280653951e-05,
    'Xa': 8.174386920980927e-05,
    'Xi': 2.7247956403269754e-05,
    'Yo': 0.0007084468664850137,
    'Ya': 0.00021798365122615803,
    'Ye': 8.174386920980927e-05,
    'Yv': 5.449591280653951e-05,
    'Yu': 5.449591280653951e-05,
    'Yi': 2.7247956403269754e-05,
    'Zu': 0.014850136239782017,
    'Ze': 0.01013623978201635,
    'Zi': 0.0040599455040871936,
    'Za': 0.0030245231607629428,
    'Zo': 0.0007084468664850137,
    'Zy': 0.00013623978201634878,
    'Zs': 5.449591280653951e-05,
    'Zl': 2.7247956403269754e-05,
    'Zh': 2.7247956403269754e-05
}

# import numpy as np
# brackets1 = np.percentile(
#     [num for _, num in derechar.items()],
#     q=[100 / 6, 100 / 3, 50, 200 / 3, 500 / 6, 100])
# brackets2 = np.percentile(
#     [num for _, num in derebigr.items()],
#     q=[10, 20, 30, 40, 50, 60, 70, 80, 90, 100])

brackets1 = [
    0.00817610062893082, 
    0.014067085953878409, 
    0.024842767295597486, 
    0.07211740041928721, 
    0.2587002096436058, 
    1.0
]

brackets2 = [
    0.00016348773841961853, 
    0.0010081743869209809, 
    0.0026975476839237057, 
    0.005694822888283379, 
    0.010408719346049046, 
    0.016839237057220707, 
    0.024877384196185286, 
    0.041961852861035424, 
    0.09209809264305177, 
    1.0
]

# util fun
def clip_int16(x):
    return max(-32768, min(32767, x))


def find_percentile(f, brackets):
    for i, b in enumerate(brackets):
        if f <= b:
            return i
    return len(brackets) - 1


@ray.remote
def derechar_to_int16_wrapper(sent: str):
    # lookup frequencies
    freqs = [derechar.get(c, 0.0) for c in sent]
    # assign to percentile
    percentile = [find_percentile(f, brackets1) for f in freqs]
    # count percentile
    cnt = [0] * 6
    for p in percentile:
        cnt[p] += 1
    # done
    return (
        clip_int16(len(sent)),
        *[clip_int16(c) for c in cnt]
    )

@ray.remote
def derebigram_to_int16_wrapper(sent: str):
    if len(sent) >= 3:
        # lookup frequencies
        freqs = [
            derebigr.get(sent[i:(i + 2)], 0.0)
            for i in range(1, len(sent) - 1)]
        # assign to decentile
        percentile = [find_percentile(f, brackets2) for f in freqs]
        # count decentiles
        cnt = [0] * 10
        for p in percentile:
            cnt[p] += 1
        # done
        return (
            clip_int16(len(sent)),
            *[clip_int16(c) for c in cnt]
        )
    else:
        return [1] + [0] * 10


def derechar_to_int16(sentences: List[str]):
    try:
        return ray.get([
            derechar_to_int16_wrapper.remote(sent)
            for sent in sentences])
    except Exception as e:
        logger.error(e)
        ray.shutdown()
        gc.collect()


def derebigram_to_int16(sentences: List[str]):
    try:
        return ray.get([
            derebigram_to_int16_wrapper.remote(sent)
            for sent in sentences])
    except Exception as e:
        logger.error(e)
        ray.shutdown()
        gc.collect()


if __name__ == '__main__':
    logger.info("Start")
    start = timer()

    # read data
    with jsonlines.open(args.input_file) as reader:
        batch_sentences, data = [], []
        for obj in reader:
            sent = obj.pop("sentence")
            sent_id = obj.pop("sent_id")
            batch_sentences.append(sent)
            data.append({"sent_id": sent_id})

            # start processing the batch
            if len(data) == args.batch_size:
                # process with ray.io
                results1 = derechar_to_int16(batch_sentences)
                results2 = derebigram_to_int16(batch_sentences)
                del batch_sentences

                # write data
                with jsonlines.open(args.output_file, mode='a') as writer:
                    for obj, res1, res2 in zip(data, results1, results2):
                        obj["feats6"] = res1
                        obj["feats7"] = res2
                        writer.write(obj)

                del results1, results2, data
                batch_sentences, data = [], []

    if len(data) > 0:
        results1 = derechar_to_int16(batch_sentences)
        results2 = derebigram_to_int16(batch_sentences)
        with jsonlines.open(args.output_file, mode='a') as writer:
            for obj, res1, res2 in zip(data, results1, results2):
                obj["feats6"] = res1
                obj["feats7"] = res2
                writer.write(obj)

    # done
    ray.shutdown()
    gc.collect()
    logger.info(f"End: {timer() - start: .6f} sec. elapsed")

